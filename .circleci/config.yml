version: 2.1

orbs:
  cfa: continuousauth/npm@1.0.2
  node: electronjs/node@1.4.1

jobs:
  test-electron:
    executor: node/linux
    parameters:
      electron-version:
        type: integer
    steps:
      - node/test:
          node-version: '18.12'
          test-steps:
            - run: yarn add "electron@<< parameters.electron-version >>"
            - run: yarn tsc
            - run: |
                if [[ << parameters.electron-version >> -eq 12 ]]; then
                  yarn test:ci --in-process-gpu;
                else
                  yarn test:ci;
                fi
            - store_test_results:
                path: test-results
          use-test-steps: true

workflows:
  test_and_release:
    jobs:
      - test-electron:
          matrix:
            parameters:
              electron-version:
                - 12
                - 13
                - 14
                - 15
                - 16
                - 17
                - 18
                - 19
                - 20
                - 21
                - 22
                - 23
                - 24
                - 25
      - cfa/release:
          requires:
            - test-electron
          filters:
            branches:
              only:
                - main
          context: cfa-release
